# üè¢ Property Service - H∆∞·ªõng D·∫´n ƒê·∫ßy ƒê·ªß

Service qu·∫£n l√Ω b·∫•t ƒë·ªông s·∫£n v√† ƒëi·ªÅu ph·ªëi minting NFT cho ViePropChain.

---

## ÔøΩ SETUP NHANH

### 1. C√†i ƒë·∫∑t

```bash
cd property-service
npm install
```

### 2. Ch·∫°y service

```bash
npm start
```

‚Üí Service ch·∫°y t·∫°i: `http://localhost:3003`

**L∆∞u √Ω:** C·∫ßn ch·∫°y Ganache + Minting Service tr∆∞·ªõc!

---

## üß™ TEST V·ªöI POSTMAN (KH√îNG C·∫¶N ENVIRONMENT)

### B∆∞·ªõc 1: Ch·∫°y c√°c service (3 terminals)

**Terminal 1 - Ganache:**

```bash
cd d:\DACN\RE-Chain\viepropchain
ganache -m "arm either chef prosper fish lonely rigid antique dawn stumble wife camera" --database.dbPath "./ganache-data-dev" --chain.networkId 1337 --server.port 8545
```

**Terminal 2 - Minting Service:**

```bash
cd d:\DACN\RE-Chain\database_viepropchain_microservice\minting-service
npm start
```

**Terminal 3 - Property Service:**

```bash
cd d:\DACN\RE-Chain\database_viepropchain_microservice\property-service
npm start
```

---

### B∆∞·ªõc 2: Test c√°c API

#### ‚úÖ TEST 1: Health Check

```
GET http://localhost:3003/health
```

---

#### ‚úÖ TEST 2: T·∫°o Property

```
POST http://localhost:3003/properties
Content-Type: application/json

{
  "propertyType": "apartment",
  "name": "CƒÉn h·ªô Vinhomes Central Park",
  "description": "CƒÉn h·ªô 2PN view s√¥ng tuy·ªát ƒë·∫πp",
  "price": {
    "amount": 5000000000,
    "currency": "VND"
  },
  "location": {
    "address": "208 Nguy·ªÖn H·ªØu C·∫£nh, P.22, Q.B√¨nh Th·∫°nh",
    "city": "TP. H·ªì Ch√≠ Minh",
    "district": "B√¨nh Th·∫°nh"
  },
  "details": {
    "projectName": "Vinhomes Central Park",
    "apartmentCode": "L3-1205",
    "block": "Landmark 3",
    "floor": 12,
    "bedrooms": 2,
    "bathrooms": 2,
    "netArea": "80m2",
    "balconyDirection": "ƒê√¥ng Nam",
    "legalStatus": "S·ªï h·ªìng"
  },
  "media": {
    "images": [
      {
        "url": "https://example.com/image1.jpg",
        "isPrimary": true
      }
    ]
  },
  "owner": {
    "walletAddress": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb4",
    "name": "Nguy·ªÖn VƒÉn A"
  }
}
```

**‚Üí Copy `_id` t·ª´ response ƒë·ªÉ d√πng cho test ti·∫øp theo**

---

#### ‚úÖ TEST 3: Get All Properties

```
GET http://localhost:3003/properties
```

---

#### ‚úÖ TEST 4: Get Property By ID

```
GET http://localhost:3003/properties/{property_id}
```

**Thay `{property_id}` b·∫±ng ID t·ª´ TEST 2**

---

#### ‚úÖ TEST 5: Mint Property to NFT (QUAN TR·ªåNG)

```
POST http://localhost:3003/properties/{property_id}/mint
Content-Type: application/json

{
  "recipient": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb4"
}
```

**Thay `{property_id}` b·∫±ng ID t·ª´ TEST 2**

**Response s·∫Ω c√≥:**

- `tokenId`: S·ªë th·ª© t·ª± NFT
- `transactionHash`: Hash giao d·ªãch tr√™n blockchain
- `tokenURI`: Link IPFS metadata
- `contractAddress`: ƒê·ªãa ch·ªâ smart contract

---

#### ‚úÖ TEST 6: Update Property

```
PUT http://localhost:3003/properties/{property_id}
Content-Type: application/json

{
  "price": {
    "amount": 5500000000
  },
  "status": "for_sale",
  "details": {
    "interiorStatus": "N·ªôi th·∫•t ƒë·∫ßy ƒë·ªß"
  }
}
```

---

#### ‚úÖ TEST 7: Get Statistics

```
GET http://localhost:3003/properties/stats/overview
```

---

#### ‚úÖ TEST 8: Search Properties

```
GET http://localhost:3003/properties?propertyType=apartment&city=TP. H·ªì Ch√≠ Minh&minPrice=3000000000&maxPrice=6000000000
```

---

#### ‚úÖ TEST 9: Increment View Count

```
POST http://localhost:3003/properties/{property_id}/view
```

---

#### ‚úÖ TEST 10: Delete Property

```
DELETE http://localhost:3003/properties/{property_id}
```

---

## üìä GI·∫¢I TH√çCH D·ªÆ LI·ªÜU

### IPFS (Kh√¥ng thay ƒë·ªïi - Immutable)

```json
{
  "name": "CƒÉn h·ªô Vinhomes Central Park",
  "description": "CƒÉn h·ªô 2PN view s√¥ng",
  "image": "https://example.com/image1.jpg",
  "external_url": "https://viepropchain.com/properties/123",
  "attributes": [
    { "trait_type": "Property Type", "value": "apartment" },
    { "trait_type": "Bedrooms", "value": "2" },
    { "trait_type": "Location", "value": "TP. H·ªì Ch√≠ Minh" }
  ],
  "legal_documents": [{ "name": "S·ªï h·ªìng", "url": "ipfs://..." }]
}
```

### MongoDB (C√≥ th·ªÉ thay ƒë·ªïi - Mutable)

```json
{
  "tokenId": 1,
  "contractAddress": "0x52B42Ac0e051A4c3386791b04391510C3cE06632",
  "owner": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb4",
  "status": "for_sale",
  "price": { "amount": 5000000000, "currency": "VND" },
  "listingPrice": { "amount": 5500000000, "updatedAt": "..." },
  "auctionInfo": {
    "isAuction": true,
    "startingBid": 5000000000,
    "currentBid": 5200000000,
    "endTime": "2024-12-31T23:59:59Z"
  },
  "analytics": {
    "views": 100,
    "favorites": 10,
    "shares": 5
  }
}
```

**Cache t·ª´ IPFS trong MongoDB:**

- `name`, `imageUrl`, `attributes` ‚Üí ƒê·ªÉ query nhanh kh√¥ng c·∫ßn g·ªçi IPFS

---

## üèóÔ∏è KI·∫æN TR√öC MICROSERVICES

### üìê S∆° ƒë·ªì t·ªïng quan

```
Frontend (React) ‚Üí API Gateway ‚Üí Microservices ‚Üí MongoDB/Blockchain
```

### üéØ C√°c Services

#### 1. API Gateway

- **Port:** 3000
- **Nhi·ªám v·ª•:** C·ªïng v√†o duy nh·∫•t, ƒë·ªãnh tuy·∫øn requests ƒë·∫øn c√°c microservices
- **C√¥ng ngh·ªá:** Express.js/NestJS
- **Routes:** `/api/auth/*`, `/api/properties/*`, `/api/admin/*`, `/api/blockchain/*`

#### 2. Auth Service

- **Port:** 3001
- **Nhi·ªám v·ª•:** "Sign-in with Ethereum" - X√°c th·ª±c ch·ªØ k√Ω v√≠, t·∫°o JWT token
- **Flow:**
  1. User connect wallet
  2. Generate message ƒë·ªÉ user k√Ω
  3. Verify signature
  4. T·∫°o session token (JWT)

#### 3. IPFS Service

- **Port:** 3002
- **Nhi·ªám v·ª•:** Upload files (images, documents, JSON) l√™n IPFS, tr·∫£ v·ªÅ CID
- **Pinning:** S·ª≠ d·ª•ng Pinata
- **API:**
  - `POST /ipfs/upload` - Upload file
  - `POST /ipfs/metadata` - Upload metadata JSON
  - `GET /ipfs/:cid` - Get file by CID

#### 4. Admin Service (Property Management)

- **Port:** 3003
- **Nhi·ªám v·ª•:**
  - Qu·∫£n l√Ω CRUD b·∫•t ƒë·ªông s·∫£n
  - T·∫°o metadata NFT
  - G·ªçi Blockchain Service ƒë·ªÉ mint NFT
- **Database:** MongoDB - Collection `properties`
- **T∆∞∆°ng t√°c:** IPFS Service + Blockchain Service

#### 5. Blockchain Service

- **Port:** 3004
- **Nhi·ªám v·ª•:**
  - Service DUY NH·∫§T t∆∞∆°ng t√°c blockchain
  - Qu·∫£n l√Ω private key c·ªßa Admin
  - G·ª≠i signed transactions
- **API:**
  - `POST /blockchain/mint` - Mint NFT
  - `POST /blockchain/list` - List NFT for sale
  - `POST /blockchain/buy` - Buy NFT
  - `GET /blockchain/nft/:tokenId` - Get NFT info

#### 6. Indexer Service (Worker)

- **Port:** N/A (Background worker)
- **Nhi·ªám v·ª•:**
  - L·∫Øng nghe events t·ª´ Smart Contract 24/7
  - Events: `Transfer`, `ItemListed`, `ItemSold`, `ItemCanceled`
  - C·∫≠p nh·∫≠t MongoDB real-time
- **Poll Interval:** 3 seconds
- **Database:** MongoDB - Collection `properties`

#### 7. Query Service (Read-Only)

- **Port:** 3005
- **Nhi·ªám v·ª•:**
  - API ch·ªâ ƒë·ªçc cho Frontend
  - Queries ph·ª©c t·∫°p: search, filter, sort, pagination
  - Optimized for performance
- **Database:** MongoDB (Read Replicas n·∫øu scale)
- **API:**
  - `GET /query/properties` - List with filters
  - `GET /query/properties/:id` - Get detail
  - `GET /query/stats` - Statistics
  - `GET /query/search` - Full-text search

---

## üóÇÔ∏è C·∫§U TR√öC DATABASE (MongoDB)

### Collection: `properties`

```javascript
{
  // ==================== SECTION 1: BASIC INFO ====================
  // Cache t·ª´ IPFS ƒë·ªÉ query nhanh, kh√¥ng c·∫ßn g·ªçi IPFS m·ªói l·∫ßn
  propertyType: 'apartment' | 'land' | 'house' | 'villa',
  name: String,              // Cache t·ª´ IPFS metadata
  description: String,       // Cache t·ª´ IPFS metadata
  imageUrl: String,          // Primary image, cache t·ª´ IPFS

  // ==================== SECTION 2: BLOCKCHAIN/NFT INFO ====================
  // ƒê∆∞·ª£c c·∫≠p nh·∫≠t b·ªüi Blockchain Service v√† Indexer Service
  nft: {
    isMinted: Boolean,       // ƒê√£ mint NFT ch∆∞a?
    tokenId: Number,         // Token ID on-chain
    contractAddress: String, // Smart contract address
    owner: String,           // Current owner address (sync b·ªüi Indexer)
    tokenURI: String,        // IPFS URI c·ªßa metadata
    transactionHash: String, // Mint transaction hash
    ipfsHash: String,        // IPFS CID c·ªßa metadata
    mintedAt: Date,          // Th·ªùi ƒëi·ªÉm mint
    mintedBy: String         // Admin address ƒë√£ mint
  },

  // ==================== SECTION 3: MARKETPLACE INFO ====================
  // ƒê∆∞·ª£c c·∫≠p nh·∫≠t b·ªüi Indexer Service khi l·∫Øng nghe events
  marketplace: {
    isListed: Boolean,           // ƒêang listing kh√¥ng?
    price: Number,               // Gi√° listing hi·ªán t·∫°i (Wei)
    seller: String,              // ƒê·ªãa ch·ªâ seller
    listedAt: Date,              // Th·ªùi ƒëi·ªÉm list
    listingId: Number,           // ID listing on-chain
    lastSoldPrice: Number,       // Gi√° b√°n l·∫ßn cu·ªëi
    lastSoldAt: Date,            // Th·ªùi ƒëi·ªÉm b√°n l·∫ßn cu·ªëi
    salesHistory: [{             // L·ªãch s·ª≠ giao d·ªãch
      seller: String,
      buyer: String,
      price: Number,
      soldAt: Date,
      transactionHash: String
    }]
  },

  // ==================== SECTION 4: AUCTION INFO ====================
  // Optional - N·∫øu c√≥ t√≠nh nƒÉng ƒë·∫•u gi√°
  auctionInfo: {
    isAuction: Boolean,
    startingBid: Number,
    currentBid: Number,
    highestBidder: String,
    startTime: Date,
    endTime: Date,
    minBidIncrement: Number,
    bids: [{
      bidder: String,
      amount: Number,
      bidAt: Date
    }]
  },

  // ==================== SECTION 5: PROPERTY DETAILS ====================
  // Chi ti·∫øt b·∫•t ƒë·ªông s·∫£n, ƒë∆∞·ª£c l∆∞u v√†o IPFS attributes
  location: {
    address: String,
    ward: String,
    district: String,
    city: String,
    coordinates: {
      latitude: Number,
      longitude: Number
    }
  },

  details: {
    // Apartment
    projectName: String,
    apartmentCode: String,
    block: String,
    floor: Number,
    bedrooms: Number,
    bathrooms: Number,
    netArea: String,
    grossArea: String,
    balconyDirection: String,
    interiorStatus: String,
    legalStatus: String,

    // Land
    landNumber: String,
    mapSheetNumber: String,
    frontWidth: Number,
    length: Number,
    landType: String,
    zoning: String,

    // House/Villa
    landArea: String,
    constructionArea: String,
    usableArea: String,
    structure: String,
    constructionYear: Number,
    houseDirection: String
  },

  // ==================== SECTION 6: MEDIA ====================
  media: {
    images: [{
      url: String,           // IPFS URL
      caption: String,
      isPrimary: Boolean
    }],
    documents: [{
      name: String,          // "S·ªï h·ªìng", "Gi·∫•y ph√©p x√¢y d·ª±ng"
      url: String,           // IPFS URL
      type: String           // "legal", "certificate"
    }],
    videos: [String],        // IPFS URLs
    virtualTour: String      // 360 tour URL
  },

  // ==================== SECTION 7: ANALYTICS ====================
  // ƒê∆∞·ª£c c·∫≠p nh·∫≠t b·ªüi Query Service
  analytics: {
    views: Number,           // S·ªë l∆∞·ª£t xem
    favorites: Number,       // S·ªë l∆∞·ª£t y√™u th√≠ch
    shares: Number,          // S·ªë l∆∞·ª£t chia s·∫ª
    inquiries: Number,       // S·ªë l∆∞·ª£t h·ªèi
    lastViewedAt: Date       // L·∫ßn xem g·∫ßn nh·∫•t
  },

  // ==================== SECTION 8: OWNER & AGENT ====================
  owner: {
    userId: String,          // User ID trong h·ªá th·ªëng
    walletAddress: String,   // Ethereum address
    name: String,
    email: String,
    phone: String
  },

  agent: {
    userId: String,
    name: String,
    phone: String,
    email: String,
    commission: Number       // % hoa h·ªìng
  },

  // ==================== SECTION 9: STATUS & METADATA ====================
  status: String,            // 'draft' | 'published' | 'minted' |
                             // 'listed' | 'sold' | 'archived'

  isPublic: Boolean,         // Hi·ªÉn th·ªã c√¥ng khai kh√¥ng?
  isFeatured: Boolean,       // B·∫•t ƒë·ªông s·∫£n n·ªïi b·∫≠t
  tags: [String],            // Tags ƒë·ªÉ search
  category: String,          // 'residential' | 'commercial' | 'industrial'

  // ==================== SECTION 10: TIMESTAMPS ====================
  createdAt: Date,           // Th·ªùi ƒëi·ªÉm t·∫°o
  updatedAt: Date,           // Th·ªùi ƒëi·ªÉm update cu·ªëi
  publishedAt: Date,         // Th·ªùi ƒëi·ªÉm publish
  archivedAt: Date           // Th·ªùi ƒëi·ªÉm archive
}
```

### Collection: `users`

```javascript
{
  walletAddress: String,     // Primary key, lowercase
  nonce: String,             // ƒê·ªÉ verify signature
  sessionToken: String,      // JWT token
  role: String,              // 'user' | 'admin' | 'agent'
  profile: {
    name: String,
    email: String,
    phone: String,
    avatar: String
  },
  favorites: [ObjectId],     // Array property IDs
  createdAt: Date,
  lastLoginAt: Date
}
```

### Collection: `transactions`

```javascript
{
  transactionHash: String,   // On-chain transaction hash
  type: String,              // 'mint' | 'list' | 'buy' | 'cancel'
  propertyId: ObjectId,
  tokenId: Number,
  from: String,              // Address
  to: String,                // Address
  price: Number,             // Wei
  blockNumber: Number,
  timestamp: Date,
  status: String,            // 'pending' | 'confirmed' | 'failed'
  gasUsed: Number,
  gasPrice: Number
}
```

---

## üîÑ FLOW HO·∫†T ƒê·ªòNG

### 1. Authentication Flow (Sign-in with Ethereum)

```
Frontend ‚Üí API Gateway ‚Üí Auth Service
‚îú‚îÄ 1. User click "Connect Wallet"
‚îú‚îÄ 2. Frontend request nonce t·ª´ Auth Service
‚îú‚îÄ 3. Auth Service generate random nonce, l∆∞u v√†o DB
‚îú‚îÄ 4. Frontend show message: "Sign this message to login: {nonce}"
‚îú‚îÄ 5. User k√Ω message b·∫±ng wallet (MetaMask)
‚îú‚îÄ 6. Frontend g·ª≠i signature + walletAddress l√™n Auth Service
‚îú‚îÄ 7. Auth Service verify signature
‚îú‚îÄ 8. N·∫øu h·ª£p l·ªá ‚Üí T·∫°o JWT token, tr·∫£ v·ªÅ Frontend
‚îî‚îÄ 9. Frontend l∆∞u token, g·ª≠i k√®m m·ªçi request ti·∫øp theo
```

### 2. Admin Create Property + Mint NFT Flow

```
Admin Frontend ‚Üí API Gateway ‚Üí Admin Service ‚Üí IPFS Service ‚Üí Blockchain Service
‚îú‚îÄ STEP 1: Admin t·∫°o property
‚îÇ   ‚îú‚îÄ POST /api/admin/properties
‚îÇ   ‚îú‚îÄ Admin Service validate data
‚îÇ   ‚îú‚îÄ L∆∞u v√†o MongoDB v·ªõi status='draft'
‚îÇ   ‚îî‚îÄ Tr·∫£ v·ªÅ propertyId
‚îÇ
‚îú‚îÄ STEP 2: Admin upload media
‚îÇ   ‚îú‚îÄ POST /api/admin/properties/:id/upload-images
‚îÇ   ‚îú‚îÄ Admin Service g·ªçi IPFS Service
‚îÇ   ‚îú‚îÄ IPFS Service upload l√™n Pinata
‚îÇ   ‚îú‚îÄ Tr·∫£ v·ªÅ IPFS CIDs
‚îÇ   ‚îî‚îÄ Admin Service c·∫≠p nh·∫≠t media.images trong MongoDB
‚îÇ
‚îú‚îÄ STEP 3: Admin request mint NFT
‚îÇ   ‚îú‚îÄ POST /api/admin/properties/:id/mint
‚îÇ   ‚îú‚îÄ Admin Service build metadata JSON:
‚îÇ   ‚îÇ   {
‚îÇ   ‚îÇ     "name": "...",
‚îÇ   ‚îÇ     "description": "...",
‚îÇ   ‚îÇ     "image": "ipfs://...",
‚îÇ   ‚îÇ     "attributes": [...],
‚îÇ   ‚îÇ     "legal_documents": [...]
‚îÇ   ‚îÇ   }
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ Admin Service g·ªçi IPFS Service upload metadata
‚îÇ   ‚îú‚îÄ IPFS Service tr·∫£ v·ªÅ metadataURI (ipfs://...)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ Admin Service g·ªçi Blockchain Service:
‚îÇ   ‚îÇ   POST /blockchain/mint
‚îÇ   ‚îÇ   {
‚îÇ   ‚îÇ     "recipient": "0x...",
‚îÇ   ‚îÇ     "tokenURI": "ipfs://..."
‚îÇ   ‚îÇ   }
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ Blockchain Service:
‚îÇ   ‚îÇ   ‚îú‚îÄ L·∫•y private key c·ªßa Admin wallet (t·ª´ .env)
‚îÇ   ‚îÇ   ‚îú‚îÄ K·∫øt n·ªëi Ethereum node (Ganache/Infura)
‚îÇ   ‚îÇ   ‚îú‚îÄ G·ªçi contract.mint(recipient, tokenURI)
‚îÇ   ‚îÇ   ‚îú‚îÄ K√Ω transaction b·∫±ng Admin private key
‚îÇ   ‚îÇ   ‚îú‚îÄ G·ª≠i transaction l√™n blockchain
‚îÇ   ‚îÇ   ‚îú‚îÄ ƒê·ª£i confirmation
‚îÇ   ‚îÇ   ‚îî‚îÄ Tr·∫£ v·ªÅ: { tokenId, transactionHash, contractAddress }
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ Admin Service c·∫≠p nh·∫≠t MongoDB:
‚îÇ       ‚îú‚îÄ nft.isMinted = true
‚îÇ       ‚îú‚îÄ nft.tokenId = tokenId
‚îÇ       ‚îú‚îÄ nft.transactionHash = transactionHash
‚îÇ       ‚îú‚îÄ status = 'minted'
‚îÇ       ‚îî‚îÄ Tr·∫£ v·ªÅ response cho Admin
```

### 3. Indexer Service - Real-time Event Sync

```
Indexer Service (Background Worker ch·∫°y 24/7)
‚îú‚îÄ Poll blockchain m·ªói 3 gi√¢y
‚îú‚îÄ L·∫Øng nghe Smart Contract Events:
‚îÇ
‚îú‚îÄ EVENT: Transfer(from, to, tokenId)
‚îÇ   ‚îú‚îÄ Query MongoDB t√¨m property c√≥ tokenId
‚îÇ   ‚îú‚îÄ C·∫≠p nh·∫≠t nft.owner = to
‚îÇ   ‚îú‚îÄ N·∫øu from != 0x0 ‚Üí ƒê√¢y l√† transfer (kh√¥ng ph·∫£i mint)
‚îÇ   ‚îî‚îÄ Log: "Property #{tokenId} transferred to {to}"
‚îÇ
‚îú‚îÄ EVENT: ItemListed(tokenId, seller, price)
‚îÇ   ‚îú‚îÄ Query MongoDB t√¨m property c√≥ tokenId
‚îÇ   ‚îú‚îÄ C·∫≠p nh·∫≠t:
‚îÇ   ‚îÇ   ‚îú‚îÄ marketplace.isListed = true
‚îÇ   ‚îÇ   ‚îú‚îÄ marketplace.price = price
‚îÇ   ‚îÇ   ‚îú‚îÄ marketplace.seller = seller
‚îÇ   ‚îÇ   ‚îú‚îÄ marketplace.listedAt = now
‚îÇ   ‚îÇ   ‚îî‚îÄ status = 'listed'
‚îÇ   ‚îî‚îÄ Log: "Property #{tokenId} listed for {price} Wei"
‚îÇ
‚îú‚îÄ EVENT: ItemSold(tokenId, seller, buyer, price)
‚îÇ   ‚îú‚îÄ Query MongoDB t√¨m property c√≥ tokenId
‚îÇ   ‚îú‚îÄ C·∫≠p nh·∫≠t:
‚îÇ   ‚îÇ   ‚îú‚îÄ marketplace.isListed = false
‚îÇ   ‚îÇ   ‚îú‚îÄ marketplace.lastSoldPrice = price
‚îÇ   ‚îÇ   ‚îú‚îÄ marketplace.lastSoldAt = now
‚îÇ   ‚îÇ   ‚îú‚îÄ marketplace.salesHistory.push({seller, buyer, price, ...})
‚îÇ   ‚îÇ   ‚îú‚îÄ nft.owner = buyer (n·∫øu ch∆∞a c√≥ Transfer event)
‚îÇ   ‚îÇ   ‚îî‚îÄ status = 'sold'
‚îÇ   ‚îî‚îÄ Log: "Property #{tokenId} sold to {buyer} for {price} Wei"
‚îÇ
‚îî‚îÄ EVENT: ItemCanceled(tokenId, seller)
    ‚îú‚îÄ Query MongoDB t√¨m property c√≥ tokenId
    ‚îú‚îÄ C·∫≠p nh·∫≠t:
    ‚îÇ   ‚îú‚îÄ marketplace.isListed = false
    ‚îÇ   ‚îî‚îÄ status = 'minted'
    ‚îî‚îÄ Log: "Listing #{tokenId} canceled by {seller}"
```

### 4. User Browse & Buy NFT Flow

```
User Frontend ‚Üí API Gateway ‚Üí Query Service ‚Üí Blockchain Service
‚îú‚îÄ STEP 1: User browse properties
‚îÇ   ‚îú‚îÄ GET /api/query/properties?status=listed&propertyType=apartment
‚îÇ   ‚îú‚îÄ Query Service query MongoDB (with filters, pagination)
‚îÇ   ‚îú‚îÄ Return danh s√°ch properties (ƒë√£ ƒë∆∞·ª£c sync b·ªüi Indexer)
‚îÇ   ‚îî‚îÄ Frontend display properties
‚îÇ
‚îú‚îÄ STEP 2: User xem chi ti·∫øt
‚îÇ   ‚îú‚îÄ GET /api/query/properties/:id
‚îÇ   ‚îú‚îÄ Query Service:
‚îÇ   ‚îÇ   ‚îú‚îÄ Get property t·ª´ MongoDB
‚îÇ   ‚îÇ   ‚îú‚îÄ Increment analytics.views
‚îÇ   ‚îÇ   ‚îî‚îÄ Return property details
‚îÇ   ‚îî‚îÄ Frontend display: images, price, owner, metadata...
‚îÇ
‚îú‚îÄ STEP 3: User click "Buy Now"
‚îÇ   ‚îú‚îÄ Frontend show MetaMask confirm dialog
‚îÇ   ‚îú‚îÄ User confirm transaction trong MetaMask
‚îÇ   ‚îú‚îÄ Frontend g·ª≠i:
‚îÇ   ‚îÇ   POST /api/blockchain/buy
‚îÇ   ‚îÇ   {
‚îÇ   ‚îÇ     "tokenId": 1,
‚îÇ   ‚îÇ     "buyer": "0x...",
‚îÇ   ‚îÇ     "value": "1000000000000000000" (Wei)
‚îÇ   ‚îÇ   }
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ Blockchain Service:
‚îÇ   ‚îÇ   ‚îú‚îÄ G·ªçi contract.buyItem(tokenId) v·ªõi value=price
‚îÇ   ‚îÇ   ‚îú‚îÄ Transaction ƒë∆∞·ª£c g·ª≠i t·ª´ buyer's wallet
‚îÇ   ‚îÇ   ‚îî‚îÄ Return transactionHash
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ Frontend show "Transaction pending..."
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ Sau v√†i gi√¢y:
‚îÇ       ‚îú‚îÄ Indexer Service catch ItemSold event
‚îÇ       ‚îú‚îÄ C·∫≠p nh·∫≠t MongoDB: owner m·ªõi, status='sold'
‚îÇ       ‚îî‚îÄ Frontend refresh ‚Üí Th·∫•y owner ƒë√£ ƒë·ªïi
```

### 5. Data Consistency & Caching

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ IPFS (Source of Truth - Immutable)                  ‚îÇ
‚îÇ - name, description, image                          ‚îÇ
‚îÇ - attributes (bedrooms, location...)                ‚îÇ
‚îÇ - legal_documents                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì Cache v√†o MongoDB
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MongoDB (Cache + Mutable Data)                      ‚îÇ
‚îÇ Cache t·ª´ IPFS:                                      ‚îÇ
‚îÇ   - name, imageUrl, attributes                      ‚îÇ
‚îÇ   ‚Üí ƒê·ªÉ Query Service query nhanh                    ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ Mutable Data (sync t·ª´ Blockchain):                 ‚îÇ
‚îÇ   - nft.owner (sync b·ªüi Indexer)                   ‚îÇ
‚îÇ   - marketplace.price, isListed                     ‚îÇ
‚îÇ   - salesHistory                                    ‚îÇ
‚îÇ   - analytics (views, favorites...)                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Query Service (Read t·ª´ MongoDB)                     ‚îÇ
‚îÇ - Fast queries                                      ‚îÇ
‚îÇ - Kh√¥ng c·∫ßn g·ªçi IPFS m·ªói l·∫ßn                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üõ†Ô∏è API ENDPOINTS CH√çNH

| Method   | Endpoint                     | M√¥ t·∫£                                 |
| -------- | ---------------------------- | ------------------------------------- |
| `GET`    | `/health`                    | Ki·ªÉm tra service                      |
| `POST`   | `/properties`                | T·∫°o property m·ªõi                      |
| `GET`    | `/properties`                | L·∫•y danh s√°ch (c√≥ filter, pagination) |
| `GET`    | `/properties/:id`            | L·∫•y chi ti·∫øt 1 property               |
| `PUT`    | `/properties/:id`            | C·∫≠p nh·∫≠t property                     |
| `DELETE` | `/properties/:id`            | X√≥a property (soft delete)            |
| `POST`   | `/properties/:id/mint`       | Mint property th√†nh NFT               |
| `POST`   | `/properties/:id/view`       | TƒÉng view count                       |
| `POST`   | `/properties/:id/favorite`   | TƒÉng favorite count                   |
| `GET`    | `/properties/stats/overview` | Th·ªëng k√™ t·ªïng quan                    |

---

## ‚ö†Ô∏è L∆ØU √ù QUAN TR·ªåNG

### ‚úÖ DO:

1. **Ch·∫°y Ganache tr∆∞·ªõc** ‚Üí Minting Service ‚Üí Property Service
2. **D√πng ƒë·ªãa ch·ªâ wallet t·ª´ Ganache** l√†m recipient
3. **L∆∞u property_id** sau khi t·∫°o ƒë·ªÉ mint
4. **Check logs** khi g·∫∑p l·ªói

### ‚ùå DON'T:

1. **Kh√¥ng l∆∞u price, owner, status l√™n IPFS** (d·ªØ li·ªáu thay ƒë·ªïi)
2. **Kh√¥ng update NFT info tr·ª±c ti·∫øp** (ch·ªâ qua minting)
3. **Kh√¥ng hardcode recipient address** (l·∫•y t·ª´ Ganache)

---

## üêõ X·ª¨ L√ù L·ªñI TH∆Ø·ªúNG G·∫∂P

### L·ªói: "Cannot connect to MongoDB"

‚Üí Check MongoDB Atlas connection string trong `.env`

### L·ªói: "Minting service not available"

‚Üí Ch·∫°y minting-service tr∆∞·ªõc: `cd minting-service && npm start`

### L·ªói: "Insufficient funds"

‚Üí D√πng ƒë·ªãa ch·ªâ wallet c√≥ ETH trong Ganache

### L·ªói: "Property not found"

‚Üí Check property_id c√≥ ƒë√∫ng kh√¥ng

### Owner kh√¥ng t·ª± ƒë·ªông sync

‚Üí Check event listener ƒëang ch·∫°y trong minting-service

---

## üìù CHECKLIST TEST HO√ÄN CH·ªàNH

- [ ] Ganache ƒëang ch·∫°y (port 8545)
- [ ] Minting Service ƒëang ch·∫°y (port 3002)
- [ ] Property Service ƒëang ch·∫°y (port 3003)
- [ ] Test GET /health ‚Üí 200 OK
- [ ] Test POST /properties ‚Üí T·∫°o th√†nh c√¥ng
- [ ] Test POST /properties/:id/mint ‚Üí Mint th√†nh c√¥ng
- [ ] Test GET /properties/:id ‚Üí Th·∫•y tokenId
- [ ] Test PUT /properties/:id ‚Üí Update th√†nh c√¥ng
- [ ] Test GET /properties/stats/overview ‚Üí C√≥ data

---

**‚úÖ XONG! B√¢y gi·ªù b·∫°n c√≥ th·ªÉ test API m√† kh√¥ng c·∫ßn setup environment variables ph·ª©c t·∫°p!**
